# Backend Dashy (hôte intranet)
upstream dashy_up {
  server 192.168.11.6:4000;   # adapte si tu utilises un autre port
  keepalive 32;
}

# Redirection HTTP -> HTTPS
server {
  listen 80;
  server_name dashy.ALPHA.DOM.local;
  return 301 https://$host$request_uri;
}

# Vhost HTTPS
server {
  listen 443 ssl http2;
  server_name dashy.ALPHA.DOM.local;

  ssl_certificate           /etc/nginx/certs/fullchain.pem;
  ssl_certificate_key       /etc/nginx/certs/privkey.pem;
  ssl_trusted_certificate   /etc/nginx/certs/fullchain.pem;

  # Taille d’upload (rarement utile pour Dashy)
  client_max_body_size 20m;

  # App front (SPA) — pass-through vers Dashy
  location / {
    proxy_http_version 1.1;
    # WebSocket/SSE (au cas où certains widgets en ont besoin)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # En-têtes standards
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;

    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    proxy_redirect off;
    proxy_pass http://dashy_up;
  }

  # Cache des assets statiques (meilleures perfs)
  location ~* \.(?:css|js|mjs|png|jpg|jpeg|gif|ico|svg|webp|woff2?)$ {
    expires 7d;
    access_log off;
    proxy_pass http://dashy_up;
  }
}
